<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Godswillscorechatüó®</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</head>
<body class="bg-gray-100">
    <div id="app"></div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBzUELxbbaL6Wb_M1uNhjwlZHVTorN9XJs",
            authDomain: "my-whatsapp-2c1af.firebaseapp.com",
            projectId: "my-whatsapp-2c1af",
            storageBucket: "my-whatsapp-2c1af.firebasestorage.app",
            messagingSenderId: "1089455460888",
            appId: "1:1089455460888:web:d0c8dea185ba6769ebe96d"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Cloudinary Configuration
        const CLOUDINARY_CLOUD_NAME = 'dzxckgbzp';
        const CLOUDINARY_UPLOAD_PRESET = 'godswillscorechat';
        const CLOUDINARY_UPLOAD_URL = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`;

        // App State
        let currentUser = null;
        let currentView = 'auth';
        let selectedFriend = null;
        let messages = [];
        let friends = [];
        let allUsers = [];

        // Icons (using Unicode)
        const icons = {
            camera: 'üì∑',
            send: 'üì§',
            user: 'üë§',
            home: 'üè†',
            plus: '‚ûï',
            close: '‚úñÔ∏è',
            logout: 'üö™',
            fire: 'üî•'
        };

        // Render Functions
        function render() {
            const app = document.getElementById('app');
            if (!currentUser) {
                app.innerHTML = renderAuth();
            } else if (currentView === 'home') {
                app.innerHTML = renderHome();
            } else if (currentView === 'chat') {
                app.innerHTML = renderChat();
            }
            attachEventListeners();
        }

        function renderAuth() {
            return `
                <div class="flex items-center justify-center min-h-screen bg-gradient-to-br from-yellow-300 via-yellow-400 to-yellow-500">
                    <div class="bg-white p-8 rounded-3xl shadow-2xl max-w-md w-full mx-4">
                        <h1 class="text-4xl font-bold mb-2 text-yellow-500 text-center">Godswillscorechatüó®</h1>
                        <p class="text-gray-600 mb-6 text-center">Share moments with real people</p>
                        
                        <div id="authForm" class="space-y-4">
                            <input type="text" id="username" placeholder="Username" 
                                class="w-full px-4 py-3 border rounded-full focus:outline-none focus:ring-2 focus:ring-yellow-500" required>
                            <input type="password" id="password" placeholder="Password" 
                                class="w-full px-4 py-3 border rounded-full focus:outline-none focus:ring-2 focus:ring-yellow-500" required>
                            
                            <div id="authError" class="text-red-500 text-sm text-center hidden"></div>
                            
                            <button onclick="handleLogin()" 
                                class="w-full bg-yellow-500 text-white py-3 px-6 rounded-full font-semibold hover:bg-yellow-600 transition">
                                Log In
                            </button>
                            <button onclick="handleSignUp()" 
                                class="w-full bg-gray-200 text-gray-700 py-3 px-6 rounded-full font-semibold hover:bg-gray-300 transition">
                                Sign Up
                            </button>
                        </div>
                        
                        <div class="mt-6 p-4 bg-yellow-50 rounded-xl">
                            <p class="text-xs text-gray-600">
                                <strong>‚úÖ Real-time Chat</strong><br/>
                                ‚Ä¢ Firebase & Cloudinary<br/>
                                ‚Ä¢ Message real people instantly
                            </p>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderHome() {
            const friendsHtml = friends.length === 0 
                ? '<div class="text-center py-8 text-gray-500"><p>No friends yet. Add some friends to start chatting!</p></div>'
                : friends.map(friend => `
                    <div onclick="openChat('${friend.id}')" 
                        class="bg-white p-4 rounded-xl shadow hover:shadow-md transition cursor-pointer">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 rounded-full bg-gradient-to-br from-blue-400 to-blue-600 flex items-center justify-center text-white text-2xl">
                                    ${icons.user}
                                </div>
                                <div>
                                    <p class="font-semibold">@${friend.friendUsername}</p>
                                    <p class="text-sm text-gray-500">Tap to chat</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-2xl">${icons.fire}</span>
                                <span class="font-bold text-yellow-500">${friend.streak || 0}</span>
                            </div>
                        </div>
                    </div>
                `).join('');

            return `
                <div class="flex flex-col h-screen bg-gray-100">
                    <div class="bg-yellow-500 text-white p-4 shadow-lg">
                        <div class="flex items-center justify-between max-w-6xl mx-auto">
                            <h1 class="text-2xl font-bold">Godswillscorechatüó®</h1>
                            <div class="flex items-center gap-4">
                                <span class="text-sm font-semibold">@${currentUser.username}</span>
                                <button onclick="handleLogout()" 
                                    class="p-2 bg-yellow-600 rounded-full hover:bg-yellow-700 transition">
                                    ${icons.logout}
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="flex-1 overflow-y-auto p-4 max-w-6xl mx-auto w-full">
                        <div class="mb-6">
                            <h2 class="text-xl font-bold mb-3">Stories</h2>
                            <div class="flex gap-4 overflow-x-auto pb-2">
                                <button onclick="captureImage()" class="flex flex-col items-center flex-shrink-0">
                                    <div class="w-16 h-16 rounded-full bg-gradient-to-br from-yellow-400 to-yellow-600 flex items-center justify-center border-4 border-white shadow-lg text-white text-2xl">
                                        ${icons.plus}
                                    </div>
                                    <span class="text-xs mt-1">Add Story</span>
                                </button>
                            </div>
                        </div>

                        <div>
                            <div class="flex items-center justify-between mb-3">
                                <h2 class="text-xl font-bold">Friends</h2>
                                <button onclick="showAddFriend()" 
                                    class="bg-yellow-500 text-white px-4 py-2 rounded-full text-sm hover:bg-yellow-600">
                                    ${icons.plus} Add Friend
                                </button>
                            </div>
                            ${friendsHtml}
                        </div>
                    </div>

                    <div class="bg-white border-t p-2">
                        <div class="flex justify-around max-w-6xl mx-auto">
                            <button onclick="goHome()" class="p-3 rounded-full bg-yellow-100">
                                <span class="text-2xl">${icons.home}</span>
                            </button>
                            <button onclick="captureImage()" class="p-3 rounded-full">
                                <span class="text-2xl">${icons.camera}</span>
                            </button>
                        </div>
                    </div>
                </div>

                <input type="file" id="imageInput" accept="image/*" style="display:none;" onchange="handleImageSelect(event)">
            `;
        }

        function renderChat() {
            if (!selectedFriend) return '';

            const chatMessages = messages
                .filter(m => 
                    (m.from === currentUser.username && m.to === selectedFriend.friendUsername) ||
                    (m.to === currentUser.username && m.from === selectedFriend.friendUsername)
                )
                .sort((a, b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0));

            const messagesHtml = chatMessages.map(msg => {
                const isFromMe = msg.from === currentUser.username;
                if (msg.imageUrl) {
                    return `
                        <div class="flex ${isFromMe ? 'justify-end' : 'justify-start'}">
                            <div class="max-w-xs">
                                <img src="${msg.imageUrl}" alt="Snap" class="rounded-2xl shadow-lg">
                            </div>
                        </div>
                    `;
                } else {
                    return `
                        <div class="flex ${isFromMe ? 'justify-end' : 'justify-start'}">
                            <div class="max-w-xs p-3 rounded-2xl ${isFromMe ? 'bg-yellow-500 text-white' : 'bg-gray-200 text-gray-800'}">
                                <p>${msg.text}</p>
                            </div>
                        </div>
                    `;
                }
            }).join('');

            return `
                <div class="flex flex-col h-screen bg-gray-100">
                    <div class="bg-white p-4 shadow flex items-center gap-3">
                        <button onclick="goHome()" class="text-gray-600 hover:text-gray-800 text-2xl">
                            ${icons.close}
                        </button>
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-400 to-blue-600 flex items-center justify-center text-white text-xl">
                            ${icons.user}
                        </div>
                        <div>
                            <p class="font-semibold">@${selectedFriend.friendUsername}</p>
                            <p class="text-xs text-gray-500">${icons.fire} ${selectedFriend.streak || 0} day streak</p>
                        </div>
                    </div>

                    <div class="flex-1 overflow-y-auto p-4 space-y-3">
                        ${messagesHtml || '<p class="text-center text-gray-500">No messages yet. Send a snap!</p>'}
                    </div>

                    <div class="bg-white p-4 border-t">
                        <div class="flex gap-2">
                            <button onclick="captureImage()" 
                                class="p-3 bg-yellow-500 text-white rounded-full hover:bg-yellow-600 text-xl">
                                ${icons.camera}
                            </button>
                            <input type="text" id="messageInput" placeholder="Send a message..." 
                                class="flex-1 px-4 py-2 border rounded-full focus:outline-none focus:ring-2 focus:ring-yellow-500"
                                onkeypress="if(event.key==='Enter') sendMessage()">
                            <button onclick="sendMessage()" 
                                class="p-3 bg-yellow-500 text-white rounded-full hover:bg-yellow-600 text-xl">
                                ${icons.send}
                            </button>
                        </div>
                    </div>
                </div>

                <input type="file" id="imageInput" accept="image/*" style="display:none;" onchange="handleImageSelect(event)">
            `;
        }

        // Event Handlers
        async function handleSignUp() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('authError');

            if (!username || !password) {
                errorDiv.textContent = 'Please enter username and password';
                errorDiv.classList.remove('hidden');
                return;
            }

            try {
                const usernameQuery = await db.collection('users').where('username', '==', username).get();
                if (!usernameQuery.empty) {
                    errorDiv.textContent = 'Username already taken';
                    errorDiv.classList.remove('hidden');
                    return;
                }

                const email = `${username}@godswillscorechat.app`;
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                
                await db.collection('users').doc(userCredential.user.uid).set({
                    uid: userCredential.user.uid,
                    username: username,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            } catch (error) {
                errorDiv.textContent = error.message;
                errorDiv.classList.remove('hidden');
            }
        }

        async function handleLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('authError');

            if (!username || !password) {
                errorDiv.textContent = 'Please enter username and password';
                errorDiv.classList.remove('hidden');
                return;
            }

            try {
                const usernameQuery = await db.collection('users').where('username', '==', username).get();
                if (usernameQuery.empty) {
                    errorDiv.textContent = 'Username not found';
                    errorDiv.classList.remove('hidden');
                    return;
                }

                const email = `${username}@godswillscorechat.app`;
                await auth.signInWithEmailAndPassword(email, password);
            } catch (error) {
                errorDiv.textContent = 'Incorrect password';
                errorDiv.classList.remove('hidden');
            }
        }

        async function handleLogout() {
            await auth.signOut();
        }

        function goHome() {
            currentView = 'home';
            selectedFriend = null;
            render();
        }

        function openChat(friendId) {
            selectedFriend = friends.find(f => f.id === friendId);
            currentView = 'chat';
            render();
        }

        function captureImage() {
            document.getElementById('imageInput').click();
        }

        async function handleImageSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                await uploadToCloudinary(e.target.result);
            };
            reader.readAsDataURL(file);
        }

        async function uploadToCloudinary(imageData) {
            if (!selectedFriend) {
                alert('Please select a friend first');
                return;
            }

            try {
                const blob = await fetch(imageData).then(r => r.blob());
                const formData = new FormData();
                formData.append('file', blob);
                formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
                formData.append('folder', 'godswillscorechat');

                const response = await fetch(CLOUDINARY_UPLOAD_URL, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                await db.collection('messages').add({
                    from: currentUser.username,
                    to: selectedFriend.friendUsername,
                    imageUrl: data.secure_url,
                    publicId: data.public_id,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    type: 'snap'
                });

                alert('Snap sent! üéâ');
            } catch (error) {
                console.error('Upload error:', error);
                alert('Failed to upload image');
            }
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            
            if (!text || !selectedFriend) return;

            try {
                await db.collection('messages').add({
                    from: currentUser.username,
                    to: selectedFriend.friendUsername,
                    text: text,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    type: 'text'
                });

                input.value = '';
            } catch (error) {
                console.error('Send error:', error);
                alert('Failed to send message');
            }
        }

        async function showAddFriend() {
            const username = prompt('Enter username to add:');
            if (!username) return;

            try {
                const userQuery = await db.collection('users').where('username', '==', username).get();
                if (userQuery.empty) {
                    alert('User not found');
                    return;
                }

                await db.collection('friends').add({
                    user: currentUser.username,
                    friendUsername: username,
                    streak: 0,
                    addedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                alert('Friend added!');
            } catch (error) {
                console.error('Add friend error:', error);
                alert('Failed to add friend');
            }
        }

        function attachEventListeners() {
            // Event listeners are inline in HTML
        }

        // Auth State Listener
        auth.onAuthStateChanged(async (firebaseUser) => {
            if (firebaseUser) {
                const userDoc = await db.collection('users').where('uid', '==', firebaseUser.uid).get();
                if (!userDoc.empty) {
                    currentUser = userDoc.docs[0].data();
                    currentView = 'home';
                    loadFriends();
                    loadMessages();
                    render();
                }
            } else {
                currentUser = null;
                currentView = 'auth';
                render();
            }
        });

        // Load Friends
        function loadFriends() {
            db.collection('friends')
                .where('user', '==', currentUser.username)
                .onSnapshot(snapshot => {
                    friends = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    if (currentView === 'home') render();
                });
        }

        // Load Messages
        function loadMessages() {
            db.collection('messages')
                .orderBy('timestamp', 'desc')
                .onSnapshot(snapshot => {
                    messages = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    if (currentView === 'chat') render();
                });
        }

        // Initial render
        render();
    </script>
</body>
</html>
