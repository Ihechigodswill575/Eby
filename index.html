<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Godswillscorechatüó®</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</head>
<body class="bg-gray-100">
    <div id="app"></div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBzUELxbbaL6Wb_M1uNhjwlZHVTorN9XJs",
            authDomain: "my-whatsapp-2c1af.firebaseapp.com",
            projectId: "my-whatsapp-2c1af",
            storageBucket: "my-whatsapp-2c1af.firebasestorage.app",
            messagingSenderId: "1089455460888",
            appId: "1:1089455460888:web:d0c8dea185ba6769ebe96d"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        const CLOUDINARY_CLOUD_NAME = 'dzxckgbzp';
        const CLOUDINARY_UPLOAD_PRESET = 'godswillscorechat';
        const CLOUDINARY_UPLOAD_URL = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`;

        let currentUser = null;
        let currentView = 'auth';
        let selectedFriend = null;
        let selectedGroup = null;
        let selectedChannel = null;
        let messages = [];
        let friends = [];
        let groups = [];
        let friendRequests = [];
        let stories = [];
        let channels = [];
        let allUsers = [];
        let editingMessageId = null;

        const icons = {
            camera: 'üì∑',
            send: 'üì§',
            user: 'üë§',
            home: 'üè†',
            plus: '‚ûï',
            close: '‚úñÔ∏è',
            logout: 'üö™',
            fire: 'üî•',
            check: '‚úì',
            doubleCheck: '‚úì‚úì',
            edit: '‚úèÔ∏è',
            delete: 'üóëÔ∏è',
            eye: 'üëÅÔ∏è',
            lock: 'üîí',
            globe: 'üåç',
            channel: 'üì¢'
        };

        function render() {
            const app = document.getElementById('app');
            if (!currentUser) {
                app.innerHTML = renderAuth();
            } else if (currentView === 'home') {
                app.innerHTML = renderHome();
            } else if (currentView === 'chat') {
                app.innerHTML = renderChat();
            } else if (currentView === 'requests') {
                app.innerHTML = renderFriendRequests();
            } else if (currentView === 'groups') {
                app.innerHTML = renderGroups();
            } else if (currentView === 'groupChat') {
                app.innerHTML = renderGroupChat();
            } else if (currentView === 'createGroup') {
                app.innerHTML = renderCreateGroup();
            } else if (currentView === 'groupInfo') {
                app.innerHTML = renderGroupInfo();
            } else if (currentView === 'channels') {
                app.innerHTML = renderChannels();
            } else if (currentView === 'createChannel') {
                app.innerHTML = renderCreateChannel();
            } else if (currentView === 'channelView') {
                app.innerHTML = renderChannelView();
            }
        }

        function renderAuth() {
            return `
                <div class="flex items-center justify-center min-h-screen bg-gradient-to-br from-yellow-300 via-yellow-400 to-yellow-500">
                    <div class="bg-white p-8 rounded-3xl shadow-2xl max-w-md w-full mx-4">
                        <h1 class="text-4xl font-bold mb-2 text-yellow-500 text-center">Godswillscorechatüó®</h1>
                        <p class="text-gray-600 mb-6 text-center">Share moments with real people</p>
                        
                        <div class="space-y-4">
                            <input type="text" id="username" placeholder="Username" 
                                class="w-full px-4 py-3 border rounded-full focus:outline-none focus:ring-2 focus:ring-yellow-500">
                            <input type="password" id="password" placeholder="Password" 
                                class="w-full px-4 py-3 border rounded-full focus:outline-none focus:ring-2 focus:ring-yellow-500">
                            
                            <div id="authError" class="text-red-500 text-sm text-center hidden"></div>
                            
                            <button onclick="handleLogin()" 
                                class="w-full bg-yellow-500 text-white py-3 px-6 rounded-full font-semibold hover:bg-yellow-600 transition">
                                Log In
                            </button>
                            <button onclick="handleSignUp()" 
                                class="w-full bg-gray-200 text-gray-700 py-3 px-6 rounded-full font-semibold hover:bg-gray-300 transition">
                                Sign Up
                            </button>
                        </div>
                        
                        <div class="mt-6 p-4 bg-yellow-50 rounded-xl">
                            <p class="text-xs text-gray-600">
                                <strong>‚úÖ Real-time Chat & Stories</strong><br/>
                                ‚Ä¢ Private & Public Stories<br/>
                                ‚Ä¢ Groups & Channels<br/>
                                ‚Ä¢ Message Editing & More!
                            </p>
                        </div>
                        
                        <div class="mt-4 text-center text-xs text-gray-500">
                            <p><strong>Contact Creator:</strong></p>
                            <p>üìß Ihechigodswill575@gmail.com</p>
                            <p>üëª Snapchat: kizoelite2</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderHome() {
            const pendingRequestsCount = friendRequests.filter(r => r.to === currentUser.username && r.status === 'pending').length;
            
            // Filter messages to only show those involving current user
            const userMessages = messages.filter(m => 
                m.from === currentUser.username || 
                m.to === currentUser.username ||
                (m.groupId && groups.some(g => g.id === m.groupId && g.members.includes(currentUser.username)))
            );
            
            const friendsHtml = friends.length === 0 
                ? '<div class="text-center py-8 text-gray-500"><p>No friends yet. Send friend requests to start chatting!</p></div>'
                : friends.map(friend => {
                    const friendMessages = userMessages.filter(m => 
                        (m.from === friend.friendUsername && m.to === currentUser.username) ||
                        (m.from === currentUser.username && m.to === friend.friendUsername)
                    ).sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                    
                    const lastMessage = friendMessages[0];
                    const lastMessageText = lastMessage 
                        ? (lastMessage.imageUrl ? 'üì∑ Photo' : lastMessage.text)
                        : 'Tap to chat';
                    
                    return `
                    <div onclick="openChat('${friend.id}')" 
                        class="bg-white p-4 hover:bg-gray-50 transition cursor-pointer border-b">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3 flex-1">
                                <div class="w-12 h-12 rounded-full bg-gradient-to-br from-blue-400 to-blue-600 flex items-center justify-center text-white text-2xl flex-shrink-0">
                                    ${icons.user}
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p class="font-semibold">@${friend.friendUsername}</p>
                                    <p class="text-sm text-gray-500 truncate">${lastMessageText}</p>
                                </div>
                            </div>
                            <div class="flex flex-col items-end gap-1">
                                ${lastMessage ? `<span class="text-xs text-gray-400">${formatTime(lastMessage.timestamp)}</span>` : ''}
                                <div class="flex items-center gap-1">
                                    <span class="text-lg">${icons.fire}</span>
                                    <span class="text-xs font-bold text-yellow-500">${friend.streak || 0}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `}).join('');

            const groupsHtml = groups.map(group => {
                const groupMessages = userMessages.filter(m => m.groupId === group.id)
                    .sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                
                const lastMessage = groupMessages[0];
                const lastMessageText = lastMessage 
                    ? (lastMessage.imageUrl ? 'üì∑ Photo' : `${lastMessage.from}: ${lastMessage.text}`)
                    : 'No messages yet';
                
                return `
                <div onclick="openGroupChat('${group.id}')" 
                    class="bg-white p-4 hover:bg-gray-50 transition cursor-pointer border-b">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3 flex-1">
                            <div class="w-12 h-12 rounded-full bg-gradient-to-br from-green-400 to-green-600 flex items-center justify-center text-white text-2xl flex-shrink-0">
                                üë•
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="font-semibold">${group.name}</p>
                                ${group.bio ? `<p class="text-xs text-gray-400 truncate">${group.bio}</p>` : ''}
                                <p class="text-sm text-gray-500 truncate">${lastMessageText}</p>
                            </div>
                        </div>
                        ${lastMessage ? `<span class="text-xs text-gray-400">${formatTime(lastMessage.timestamp)}</span>` : ''}
                    </div>
                </div>
            `}).join('');

            // Filter stories: show public stories from everyone, private stories only from friends + own stories
            const visibleStories = stories.filter(story => {
                if (story.username === currentUser.username) return true;
                if (story.isPublic) return true;
                return friends.some(f => f.friendUsername === story.username);
            });

            const storiesHtml = visibleStories.map(story => {
                const isMyStory = story.username === currentUser.username;
                const viewCount = story.viewedBy ? story.viewedBy.length : 0;
                return `
                <button onclick="viewStory('${story.id}')" class="flex flex-col items-center flex-shrink-0 relative">
                    <div class="w-16 h-16 rounded-full ${isMyStory ? 'bg-gradient-to-br from-yellow-400 to-yellow-600' : 'bg-gradient-to-br from-pink-400 to-purple-600'} p-0.5">
                        <img src="${story.imageUrl}" 
                            alt="Story by @${story.username}" 
                            class="w-full h-full rounded-full object-cover border-2 border-white">
                    </div>
                    ${isMyStory && viewCount > 0 ? `
                    <span class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">
                        ${viewCount}
                    </span>
                    ` : ''}
                    <span class="text-xs mt-1 max-w-[64px] truncate">${isMyStory ? 'My Story' : '@' + story.username}</span>
                    ${!story.isPublic ? `<span class="text-xs">${icons.lock}</span>` : `<span class="text-xs">${icons.globe}</span>`}
                </button>
            `}).join('');

            return `
                <div class="flex flex-col h-screen bg-gray-50">
                    <div class="bg-green-600 text-white p-4 shadow-lg">
                        <div class="flex items-center justify-between max-w-6xl mx-auto">
                            <h1 class="text-xl font-semibold">Godswillscorechat</h1>
                            <div class="flex items-center gap-3">
                                <button onclick="captureImage()" class="p-2 hover:bg-green-700 rounded-full transition">
                                    ${icons.camera}
                                </button>
                                <button onclick="showFriendRequests()" class="relative p-2 hover:bg-green-700 rounded-full transition">
                                    üì¨
                                    ${pendingRequestsCount > 0 ? `<span class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">${pendingRequestsCount}</span>` : ''}
                                </button>
                                <button onclick="handleLogout()" class="p-2 hover:bg-green-700 rounded-full transition">
                                    ${icons.logout}
                                </button>
                            </div>
                        </div>
                    </div>

                    ${visibleStories.length > 0 || stories.some(s => s.username === currentUser.username) ? `
                    <div class="bg-white border-b p-3">
                        <div class="flex gap-3 overflow-x-auto">
                            <button onclick="captureImage()" class="flex flex-col items-center flex-shrink-0">
                                <div class="w-16 h-16 rounded-full bg-gradient-to-br from-gray-200 to-gray-300 flex items-center justify-center border-2 border-gray-400 text-2xl">
                                    ${icons.plus}
                                </div>
                                <span class="text-xs mt-1">Add</span>
                            </button>
                            ${storiesHtml}
                        </div>
                    </div>
                    ` : ''}

                    <div class="flex-1 overflow-y-auto">
                        ${groups.length > 0 ? groupsHtml : ''}
                        ${friendsHtml}
                    </div>

                    <div class="bg-white border-t p-2 flex justify-around">
                        <button onclick="goHome()" class="p-3 text-green-600">
                            <span class="text-2xl">üí¨</span>
                        </button>
                        <button onclick="showAllGroups()" class="p-3 text-gray-600">
                            <span class="text-2xl">üë•</span>
                        </button>
                        <button onclick="showChannels()" class="p-3 text-gray-600">
                            <span class="text-2xl">${icons.channel}</span>
                        </button>
                        <button onclick="showAddFriend()" class="p-3 text-gray-600">
                            <span class="text-2xl">‚ûï</span>
                        </button>
                    </div>
                </div>

                <input type="file" id="imageInput" accept="image/*" style="display:none;" onchange="handleImageSelect(event)">
                
                <div id="storyModal" class="hidden fixed inset-0 bg-black z-50">
                    <button onclick="closeStory()" class="absolute top-4 right-4 text-white text-3xl z-10">
                        ${icons.close}
                    </button>
                    <div id="storyContent" class="w-full h-full flex items-center justify-center">
                    </div>
                </div>
            `;
        }

        function renderChat() {
            if (!selectedFriend) return '';

            const chatMessages = messages
                .filter(m => 
                    (m.from === currentUser.username && m.to === selectedFriend.friendUsername) ||
                    (m.to === currentUser.username && m.from === selectedFriend.friendUsername)
                )
                .sort((a, b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0));

            const messagesHtml = chatMessages.map(msg => {
                const isFromMe = msg.from === currentUser.username;
                const time = formatTime(msg.timestamp);
                
                if (msg.imageUrl) {
                    return `
                        <div class="flex ${isFromMe ? 'justify-end' : 'justify-start'} mb-1 group">
                            <div class="max-w-[70%] relative">
                                <img src="${msg.imageUrl}" alt="Photo" class="rounded-lg shadow w-full">
                                <span class="absolute bottom-1 right-2 text-xs text-white bg-black bg-opacity-50 px-2 py-0.5 rounded">
                                    ${time} ${isFromMe ? icons.doubleCheck : ''}
                                </span>
                                ${isFromMe ? `
                                <button onclick="deleteMessage('${msg.id}')" class="absolute top-2 right-2 bg-red-500 text-white p-1 rounded-full opacity-0 group-hover:opacity-100 transition">
                                    ${icons.delete}
                                </button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                } else {
                    return `
                        <div class="flex ${isFromMe ? 'justify-end' : 'justify-start'} mb-1 group">
                            <div class="max-w-[70%] px-3 py-2 rounded-lg shadow-sm ${isFromMe ? 'bg-green-100 rounded-br-none' : 'bg-white rounded-bl-none'} relative">
                                <p class="text-sm break-words">${msg.text}</p>
                                <div class="flex items-center justify-end gap-1 mt-1">
                                    <span class="text-xs text-gray-500">${time}</span>
                                    ${isFromMe ? `<span class="text-xs text-blue-500">${icons.doubleCheck}</span>` : ''}
                                </div>
                                ${isFromMe ? `
                                <div class="absolute -right-16 top-0 opacity-0 group-hover:opacity-100 transition flex gap-1">
                                    <button onclick="startEditMessage('${msg.id}', \`${msg.text.replace(/`/g, '\\`')}\`)" class="bg-blue-500 text-white p-1 rounded text-xs">
                                        ${icons.edit}
                                    </button>
                                    <button onclick="deleteMessage('${msg.id}')" class="bg-red-500 text-white p-1 rounded text-xs">
                                        ${icons.delete}
                                    </button>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }
            }).join('');

            return `
                <div class="flex flex-col h-screen bg-gray-50">
                    <div class="bg-green-600 text-white p-3 shadow flex items-center gap-3">
                        <button onclick="goHome()" class="text-white text-2xl">
                            ‚Üê
                        </button>
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-400 to-blue-600 flex items-center justify-center text-white text-xl">
                            ${icons.user}
                        </div>
                        <div class="flex-1">
                            <p class="font-semibold">@${selectedFriend.friendUsername}</p>
                            <p class="text-xs text-green-100">Tap here for info</p>
                        </div>
                    </div>

                    <div id="chatMessages" class="flex-1 overflow-y-auto p-3" style="background-image: url('data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22><rect fill=%22%23e5ddd5%22 width=%22100%22 height=%22100%22/></svg>');">
                        ${messagesHtml || '<div class="flex-1 flex items-center justify-center"><p class="text-center text-gray-500 bg-white px-4 py-2 rounded-lg shadow">No messages yet. Start chatting!</p></div>'}
                    </div>

                    <div class="bg-gray-100 p-2 border-t">
                        ${editingMessageId ? `
                        <div class="bg-blue-100 p-2 rounded-lg mb-2 flex items-center justify-between">
                            <span class="text-sm text-blue-800">Editing message...</span>
                            <button onclick="cancelEditMessage()" class="text-blue-800 font-bold">Cancel</button>
                        </div>
                        ` : ''}
                        <div class="flex gap-2 items-center">
                            <button onclick="captureImage()" 
                                class="p-2 text-gray-600 hover:text-gray-800 text-2xl">
                                ${icons.camera}
                            </button>
                            <input type="text" id="messageInput" placeholder="${editingMessageId ? 'Edit message...' : 'Message'}" 
                                class="flex-1 px-4 py-2 rounded-full bg-white border focus:outline-none focus:ring-2 focus:ring-green-500"
                                onkeypress="if(event.key==='Enter') ${editingMessageId ? 'saveEditMessage()' : 'sendMessage()'}">
                            <button onclick="${editingMessageId ? 'saveEditMessage()' : 'sendMessage()'}" 
                                class="p-2 bg-green-600 text-white rounded-full hover:bg-green-700">
                                ${icons.send}
                            </button>
                        </div>
                    </div>
                </div>

                <input type="file" id="imageInput" accept="image/*" style="display:none;" onchange="handleImageSelect(event)">
            `;
        }

        function renderGroupChat() {
            if (!selectedGroup) return '';

            const chatMessages = messages
                .filter(m => m.groupId === selectedGroup.id)
                .sort((a, b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0));

            const messagesHtml = chatMessages.map(msg => {
                const isFromMe = msg.from === currentUser.username;
                const time = formatTime(msg.timestamp);
                
                if (msg.imageUrl) {
                    return `
                        <div class="flex ${isFromMe ? 'justify-end' : 'justify-start'} mb-1 group">
                            <div class="max-w-[70%] relative">
                                ${!isFromMe ? `<p class="text-xs font-semibold mb-1" style="color: ${getColorForUser(msg.from)}">~${msg.from}</p>` : ''}
                                <img src="${msg.imageUrl}" alt="Photo" class="rounded-lg shadow w-full">
                                <span class="absolute bottom-1 right-2 text-xs text-white bg-black bg-opacity-50 px-2 py-0.5 rounded">
                                    ${time} ${isFromMe ? icons.doubleCheck : ''}
                                </span>
                                ${isFromMe ? `
                                <button onclick="deleteMessage('${msg.id}')" class="absolute top-2 right-2 bg-red-500 text-white p-1 rounded-full opacity-0 group-hover:opacity-100 transition">
                                    ${icons.delete}
                                </button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                } else {
                    return `
                        <div class="flex ${isFromMe ? 'justify-end' : 'justify-start'} mb-1 group">
                            <div class="max-w-[70%] px-3 py-2 rounded-lg shadow-sm ${isFromMe ? 'bg-green-100 rounded-br-none' : 'bg-white rounded-bl-none'} relative">
                                ${!isFromMe ? `<p class="text-xs font-semibold mb-1" style="color: ${getColorForUser(msg.from)}">~${msg.from}</p>` : ''}
                                <p class="text-sm break-words">${msg.text}</p>
                                <div class="flex items-center justify-end gap-1 mt-1">
                                    <span class="text-xs text-gray-500">${time}</span>
                                    ${isFromMe ? `<span class="text-xs text-blue-500">${icons.doubleCheck}</span>` : ''}
                                </div>
                                ${isFromMe ? `
                                <div class="absolute -right-16 top-0 opacity-0 group-hover:opacity-100 transition flex gap-1">
                                    <button onclick="startEditMessage('${msg.id}', \`${msg.text.replace(/`/g, '\\`')}\`)" class="bg-blue-500 text-white p-1 rounded text-xs">
                                        ${icons.edit}
                                    </button>
                                    <button onclick="deleteMessage('${msg.id}')" class="bg-red-500 text-white p-1 rounded text-xs">
                                        ${icons.delete}
                                    </button>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }
            }).join('');

            return `
                <div class="flex flex-col h-screen bg-gray-50">
                    <div class="bg-green-600 text-white p-3 shadow flex items-center gap-3">
                        <button onclick="goHome()" class="text-white text-2xl">
                            ‚Üê
                        </button>
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-green-400 to-green-600 flex items-center justify-center text-white text-xl">
                            üë•
                        </div>
                        <div class="flex-1" onclick="showGroupInfo()">
                            <p class="font-semibold">${selectedGroup.name}</p>
                            ${selectedGroup.bio ? `<p class="text-xs text-green-100 truncate">${selectedGroup.bio}</p>` : ''}
                            <p class="text-xs text-green-100">${selectedGroup.members.length} members</p>
                        </div>
                    </div>

                    <div id="chatMessages" class="flex-1 overflow-y-auto p-3" style="background-image: url('data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22><rect fill=%22%23e5ddd5%22 width=%22100%22 height=%22100%22/></svg>');">
                        ${messagesHtml || '<div class="flex-1 flex items-center justify-center"><p class="text-center text-gray-500 bg-white px-4 py-2 rounded-lg shadow">No messages yet. Start the conversation!</p></div>'}
                    </div>

                    <div class="bg-gray-100 p-2 border-t">
                        ${editingMessageId ? `
                        <div class="bg-blue-100 p-2 rounded-lg mb-2 flex items-center justify-between">
                            <span class="text-sm text-blue-800">Editing message...</span>
                            <button onclick="cancelEditMessage()" class="text-blue-800 font-bold">Cancel</button>
                        </div>
                        ` : ''}
                        <div class="flex gap-2 items-center">
                            <button onclick="captureImage()" 
                                class="p-2 text-gray-600 hover:text-gray-800 text-2xl">
                                ${icons.camera}
                            </button>
                            <input type="text" id="messageInput" placeholder="${editingMessageId ? 'Edit message...' : 'Message'}" 
                                class="flex-1 px-4 py-2 rounded-full bg-white border focus:outline-none focus:ring-2 focus:ring-green-500"
                                onkeypress="if(event.key==='Enter') ${editingMessageId ? 'saveEditMessage()' : 'sendGroupMessage()'}">
                            <button onclick="${editingMessageId ? 'saveEditMessage()' : 'sendGroupMessage()'}" 
                                class="p-2 bg-green-600 text-white rounded-full hover:bg-green-700">
                                ${icons.send}
                            </button>
                        </div>
                    </div>
                </div>

                <input type="file" id="imageInput" accept="image/*" style="display:none;" onchange="handleImageSelect(event)">
            `;
        }

        function renderFriendRequests() {
            const pendingRequests = friendRequests.filter(r => r.to === currentUser.username && r.status === 'pending');
            
            const request
            pendingRequests.length === 0
                ? '<div class="text-center py-8 text-gray-500"><p>No pending friend requests</p></div>'
                : pendingRequests.map(request => `
                    <div class="bg-white p-4 border-b">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 rounded-full bg-gradient-to-br from-blue-400 to-blue-600 flex items-center justify-center text-white text-2xl">
                                    ${icons.user}
                                </div>
                                <div>
                                    <p class="font-semibold">@${request.from}</p>
                                    <p class="text-sm text-gray-500">wants to connect</p>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="acceptFriendRequest('${request.id}', '${request.from}')" 
                                    class="bg-green-500 text-white px-4 py-2 rounded-full text-sm hover:bg-green-600">
                                    Accept
                                </button>
                                <button onclick="rejectFriendRequest('${request.id}')" 
                                    class="bg-gray-200 text-gray-700 px-4 py-2 rounded-full text-sm hover:bg-gray-300">
                                    Decline
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');

            return `
                <div class="flex flex-col h-screen bg-gray-50">
                    <div class="bg-green-600 text-white p-4 shadow flex items-center gap-3">
                        <button onclick="goHome()" class="text-white text-2xl">
                            ‚Üê
                        </button>
                        <h2 class="text-xl font-semibold">Friend Requests</h2>
                    </div>

                    <div class="flex-1 overflow-y-auto">
                        ${requestsHtml}
                    </div>
                </div>
            `;
        }

        function renderGroups() {
            const groupsHtml = groups.length === 0
                ? '<div class="text-center py-8 text-gray-500"><p>No groups yet. Create one!</p></div>'
                : groups.map(group => `
                    <div onclick="openGroupChat('${group.id}')" 
                        class="bg-white p-4 border-b hover:bg-gray-50 transition cursor-pointer">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 rounded-full bg-gradient-to-br from-green-400 to-green-600 flex items-center justify-center text-white text-2xl">
                                üë•
                            </div>
                            <div>
                                <p class="font-semibold">${group.name}</p>
                                ${group.bio ? `<p class="text-xs text-gray-400">${group.bio}</p>` : ''}
                                <p class="text-sm text-gray-500">${group.members.length} members</p>
                            </div>
                        </div>
                    </div>
                `).join('');

            return `
                <div class="flex flex-col h-screen bg-gray-50">
                    <div class="bg-green-600 text-white p-4 shadow flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <button onclick="goHome()" class="text-white text-2xl">
                                ‚Üê
                            </button>
                            <h2 class="text-xl font-semibold">Groups</h2>
                        </div>
                        <button onclick="showCreateGroup()" 
                            class="bg-green-700 text-white p-2 rounded-full hover:bg-green-800">
                            ${icons.plus}
                        </button>
                    </div>

                    <div class="flex-1 overflow-y-auto">
                        ${groupsHtml}
                    </div>
                </div>
            `;
        }

        function renderCreateGroup() {
            const friendsCheckboxes = friends.map(friend => `
                <label class="flex items-center gap-3 p-3 bg-white border-b hover:bg-gray-50 cursor-pointer">
                    <input type="checkbox" value="${friend.friendUsername}" class="w-5 h-5 text-green-600 rounded">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-400 to-blue-600 flex items-center justify-center text-white">
                            ${icons.user}
                        </div>
                        <span class="font-medium">@${friend.friendUsername}</span>
                    </div>
                </label>
            `).join('');

            return `
                <div class="flex flex-col h-screen bg-gray-50">
                    <div class="bg-green-600 text-white p-4 shadow">
                        <div class="flex items-center gap-3 mb-4">
                            <button onclick="showAllGroups()" class="text-white text-2xl">
                                ‚Üê
                            </button>
                            <h2 class="text-xl font-semibold">New Group</h2>
                        </div>
                        <input type="text" id="groupNameInput" placeholder="Group name" 
                            class="w-full px-4 py-2 rounded-lg text-gray-900 focus:outline-none mb-2">
                        <textarea id="groupBioInput" placeholder="Group bio (optional)" 
                            class="w-full px-4 py-2 rounded-lg text-gray-900 focus:outline-none resize-none" rows="2"></textarea>
                    </div>

                    <div class="flex-1 overflow-y-auto">
                        <p class="p-3 text-sm text-gray-600 bg-gray-100">Select members</p>
                        ${friendsCheckboxes || '<div class="text-center py-8 text-gray-500"><p>Add friends first to create groups</p></div>'}
                    </div>

                    ${friends.length > 0 ? `
                    <div class="bg-white p-4 border-t">
                        <button onclick="createGroupWithMembers()" 
                            class="w-full bg-green-600 text-white py-3 rounded-full font-semibold hover:bg-green-700">
                            Create Group
                        </button>
                    </div>
                    ` : ''}
                </div>
            `;
        }

        function renderGroupInfo() {
            if (!selectedGroup) return '';

            const isAdmin = currentUser.username === selectedGroup.creator;

            const membersHtml = selectedGroup.members.map(member => {
                const isCreator = member === selectedGroup.creator;
                const isMe = member === currentUser.username;
                return `
                <div class="flex items-center justify-between p-3 bg-white border-b">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-400 to-blue-600 flex items-center justify-center text-white">
                            ${icons.user}
                        </div>
                        <div>
                            <p class="font-medium">@${member} ${isMe ? '(You)' : ''}</p>
                            ${isCreator ? '<p class="text-xs text-green-600">Group Admin</p>' : ''}
                        </div>
                    </div>
                    ${!isMe && isAdmin ? `
                    <button onclick="removeGroupMember('${member}')" class="text-red-500 text-sm">
                        Remove
                    </button>
                    ` : ''}
                </div>
            `}).join('');

            return `
                <div class="flex flex-col h-screen bg-gray-50">
                    <div class="bg-green-600 text-white p-4 shadow">
                        <div class="flex items-center gap-3">
                            <button onclick="openGroupChat('${selectedGroup.id}')" class="text-white text-2xl">
                                ‚Üê
                            </button>
                            <h2 class="text-xl font-semibold">Group Info</h2>
                        </div>
                    </div>

                    <div class="bg-white p-6 text-center border-b">
                        <div class="w-24 h-24 rounded-full bg-gradient-to-br from-green-400 to-green-600 flex items-center justify-center text-white text-5xl mx-auto mb-3">
                            üë•
                        </div>
                        <h3 class="text-xl font-bold">${selectedGroup.name}</h3>
                        ${selectedGroup.bio ? `<p class="text-sm text-gray-600 mt-1">${selectedGroup.bio}</p>` : ''}
                        <p class="text-sm text-gray-500 mt-1">Group ¬∑ ${selectedGroup.members.length} members</p>
                        ${isAdmin ? `
                        <button onclick="editGroupInfo()" class="mt-3 text-green-600 text-sm font-semibold">
                            ${icons.edit} Edit Group Info
                        </button>
                        ` : ''}
                    </div>

                    <div class="flex-1 overflow-y-auto">
                        <p class="p-3 text-sm font-semibold text-gray-600 bg-gray-100">${selectedGroup.members.length} members</p>
                        ${membersHtml}
                        
                        ${isAdmin ? `
                        <button onclick="showAddGroupMembers()" class="w-full p-4 bg-white border-b text-green-600 hover:bg-gray-50 text-left">
                            <span class="text-2xl mr-3">${icons.plus}</span>
                            Add members
                        </button>
                        ` : ''}
                    </div>

                    ${isAdmin ? `
                    <div class="bg-white p-4 border-t">
                        <button onclick="deleteGroup()" class="w-full text-red-500 font-semibold">
                            Delete Group
                        </button>
                    </div>
                    ` : `
                    <div class="bg-white p-4 border-t">
                        <button onclick="leaveGroup()" class="w-full text-red-500 font-semibold">
                            Leave Group
                        </button>
                    </div>
                    `}
                </div>
            `;
        }

        function renderChannels() {
            const channelsHtml = channels.length === 0
                ? '<div class="text-center py-8 text-gray-500"><p>No channels yet. Create one!</p></div>'
                : channels.map(channel => {
                    const isFollowing = channel.followers && channel.followers.includes(currentUser.username);
                    return `
                    <div class="bg-white p-4 border-b hover:bg-gray-50 transition">
                        <div class="flex items-center justify-between">
                            <div onclick="viewChannel('${channel.id}')" class="flex items-center gap-3 flex-1 cursor-pointer">
                                <div class="w-12 h-12 rounded-full bg-gradient-to-br from-purple-400 to-purple-600 flex items-center justify-center text-white text-2xl">
                                    ${icons.channel}
                                </div>
                                <div>
                                    <p class="font-semibold">${channel.name}</p>
                                    ${channel.description ? `<p class="text-xs text-gray-500">${channel.description}</p>` : ''}
                                    <p class="text-xs text-gray-400">${channel.followers ? channel.followers.length : 0} followers</p>
                                </div>
                            </div>
                            ${channel.creator !== currentUser.username ? `
                            <button onclick="toggleFollowChannel('${channel.id}')" 
                                class="${isFollowing ? 'bg-gray-200 text-gray-700' : 'bg-green-600 text-white'} px-4 py-2 rounded-full text-sm hover:opacity-80">
                                ${isFollowing ? 'Following' : 'Follow'}
                            </button>
                            ` : ''}
                        </div>
                    </div>
                `}).join('');

            return `
                <div class="flex flex-col h-screen bg-gray-50">
                    <div class="bg-purple-600 text-white p-4 shadow">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center gap-3">
                                <button onclick="goHome()" class="text-white text-2xl">
                                    ‚Üê
                                </button>
                                <h2 class="text-xl font-semibold">Channels</h2>
                            </div>
                            <button onclick="showCreateChannel()" 
                                class="bg-purple-700 text-white p-2 rounded-full hover:bg-purple-800">
                                ${icons.plus}
                            </button>
                        </div>
                        <input type="text" id="channelSearch" placeholder="Search channels..." 
                            oninput="filterChannels(this.value)"
                            class="w-full px-4 py-2 rounded-full text-gray-900 focus:outline-none">
                    </div>

                    <div id="channelsList" class="flex-1 overflow-y-auto">
                        ${channelsHtml}
                    </div>
                </div>
            `;
        }

        function renderCreateChannel() {
            return `
                <div class="flex flex-col h-screen bg-gray-50">
                    <div class="bg-purple-600 text-white p-4 shadow">
                        <div class="flex items-center gap-3">
                            <button onclick="showChannels()" class="text-white text-2xl">
                                ‚Üê
                            </button>
                            <h2 class="text-xl font-semibold">New Channel</h2>
                        </div>
                    </div>

                    <div class="flex-1 p-4">
                        <div class="bg-white rounded-lg p-6 shadow">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Channel Name</label>
                                    <input type="text" id="channelNameInput" placeholder="Enter channel name" 
                                        class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Description</label>
                                    <textarea id="channelDescInput" placeholder="Describe your channel" 
                                        class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 resize-none" rows="3"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-4 border-t">
                        <button onclick="createChannel()" 
                            class="w-full bg-purple-600 text-white py-3 rounded-full font-semibold hover:bg-purple-700">
                            Create Channel
                        </button>
                    </div>
                </div>
            `;
        }

        function renderChannelView() {
            if (!selectedChannel) return '';

            const isCreator = selectedChannel.creator === currentUser.username;
            const isFollowing = selectedChannel.followers && selectedChannel.followers.includes(currentUser.username);

            const channelPosts = messages
                .filter(m => m.channelId === selectedChannel.id)
                .sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));

            const postsHtml = channelPosts.length === 0
                ? '<div class="text-center py-8 text-gray-500"><p>No posts yet</p></div>'
                : channelPosts.map(post => {
                    const time = formatTime(post.timestamp);
                    return `
                    <div class="bg-white p-4 border-b">
                        ${post.imageUrl ? `
                        <img src="${post.imageUrl}" alt="Post" class="w-full rounded-lg mb-2">
                        ` : ''}
                        ${post.text ? `<p class="text-sm mb-2">${post.text}</p>` : ''}
                        <p class="text-xs text-gray-400">${time}</p>
                    </div>
                `}).join('');

            return `
                <div class="flex flex-col h-screen bg-gray-50">
                    <div class="bg-purple-600 text-white p-4 shadow">
                        <div class="flex items-center gap-3">
                            <button onclick="showChannels()" class="text-white text-2xl">
                                ‚Üê
                            </button>
                            <div class="flex-1">
                                <p class="font-semibold">${selectedChannel.name}</p>
                                ${selectedChannel.description ? `<p class="text-xs text-purple-100">${selectedChannel.description}</p>` : ''}
                                <p class="text-xs text-purple-100">${selectedChannel.followers ? selectedChannel.followers.length : 0} followers</p>
                            </div>
                            ${!isCreator ? `
                            <button onclick="toggleFollowChannel('${selectedChannel.id}')" 
                                class="${isFollowing ? 'bg-purple-700' : 'bg-white text-purple-600'} px-4 py-2 rounded-full text-sm font-semibold">
                                ${isFollowing ? 'Following' : 'Follow'}
                            </button>
                            ` : ''}
                        </div>
                    </div>

                    <div class="flex-1 overflow-y-auto">
                        ${postsHtml}
                    </div>

                    ${isCreator ? `
                    <div class="bg-gray-100 p-2 border-t">
                        <div class="flex gap-2 items-center">
                            <button onclick="captureImage()" 
                                class="p-2 text-gray-600 hover:text-gray-800 text-2xl">
                                ${icons.camera}
                            </button>
                            <input type="text" id="channelPostInput" placeholder="Share with followers..." 
                                class="flex-1 px-4 py-2 rounded-full bg-white border focus:outline-none focus:ring-2 focus:ring-purple-500"
                                onkeypress="if(event.key==='Enter') postToChannel()">
                            <button onclick="postToChannel()" 
                                class="p-2 bg-purple-600 text-white rounded-full hover:bg-purple-700">
                                ${icons.send}
                            </button>
                        </div>
                    </div>
                    ` : ''}
                </div>

                <input type="file" id="imageInput" accept="image/*" style="display:none;" onchange="handleImageSelect(event)">
            `;
        }

        function formatTime(timestamp) {
            if (!timestamp) return '';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp.seconds * 1000);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 86400000) {
                return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
            } else if (diff < 604800000) {
                return date.toLocaleDateString('en-US', { weekday: 'short' });
            } else {
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            }
        }

        function getColorForUser(username) {
            const colors = ['#1e88e5', '#e53935', '#43a047', '#fb8c00', '#8e24aa', '#00acc1', '#d81b60', '#546e7a'];
            let hash = 0;
            for (let i = 0; i < username.length; i++) {
                hash = username.charCodeAt(i) + ((hash << 5) - hash);
            }
            return colors[Math.abs(hash) % colors.length];
        }

        // Authentication functions
        async function handleSignUp() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('authError');

            if (!username || !password) {
                errorDiv.textContent = 'Please enter username and password';
                errorDiv.classList.remove('hidden');
                return;
            }

            try {
                const usernameQuery = await db.collection('users').where('username', '==', username).get();
                if (!usernameQuery.empty) {
                    errorDiv.textContent = 'Username already taken';
                    errorDiv.classList.remove('hidden');
                    return;
                }

                const email = `${username}@godswillscorechat.app`;
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                
                await db.collection('users').doc(userCredential.user.uid).set({
                    uid: userCredential.user.uid,
                    username: username,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            } catch (error) {
                errorDiv.textContent = error.message;
                errorDiv.classList.remove('hidden');
            }
        }

        async function handleLogin() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('authError');

            if (!username || !password) {
                errorDiv.textContent = 'Please enter username and password';
                errorDiv.classList.remove('hidden');
                return;
            }

            try {
                const usernameQuery = await db.collection('users').where('username', '==', username).get();
                if (usernameQuery.empty) {
                    errorDiv.textContent = 'Username not found';
                    errorDiv.classList.remove('hidden');
                    return;
                }

                const email = `${username}@godswillscorechat.app`;
                await auth.signInWithEmailAndPassword(email, password);
            } catch (error) {
                errorDiv.textContent = 'Incorrect password';
                errorDiv.classList.remove('hidden');
            }
        }

        async function handleLogout() {
            await auth.signOut();
        }

        // Navigation functions
        function goHome() {
            currentView = 'home';
            selectedFriend = null;
            selectedGroup = null;
            selectedChannel = null;
            editingMessageId = null;
            render();
        }

        function showFriendRequests() {
            currentView = 'requests';
            render();
        }

        function showAllGroups() {
            currentView = 'groups';
            render();
        }

        function showCreateGroup() {
            currentView = 'createGroup';
            render();
        }

        function showGroupInfo() {
            currentView = 'groupInfo';
            render();
        }

        function showChannels() {
            currentView = 'channels';
            render();
        }

        function showCreateChannel() {
            currentView = 'createChannel';
            render();
        }

        function viewChannel(channelId) {
            selectedChannel = channels.find(c => c.id === channelId);
            currentView = 'channelView';
            render();
        }

        function scrollToBottom() {
            setTimeout(() => {
                const chatDiv = document.getElementById('chatMessages');
                if (chatDiv) {
                    chatDiv.scrollTop = chatDiv.scrollHeight;
                }
            }, 100);
        }

        function openChat(friendId) {
            selectedFriend = friends.find(f => f.id === friendId);
            selectedGroup = null;
            currentView = 'chat';
            editingMessageId = null;
            render();
            scrollToBottom();
        }

        function openGroupChat(groupId) {
            selectedGroup = groups.find(g => g.id === groupId);
            selectedFriend = null;
            currentView = 'groupChat';
            editingMessageId = null;
            render();
            scrollToBottom();
        }

        // Message functions
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            
            if (!text || !selectedFriend) return;

            try {
                await db.collection('messages').add({
                    from: currentUser.username,
                    to: selectedFriend.friendUsername,
                    text: text,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    type: 'text'
                });
                
                input.value = '';
                scrollToBottom();
            } catch (error) {
                console.error('Send message error:', error);
                alert('Failed to send message');
            }
        }

        async function sendGroupMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            
            if (!text || !selectedGroup) return;

            try {
                await db.collection('messages').add({
                    from: currentUser.username,
                    groupId: selectedGroup.id,
                    text: text,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    type: 'group_text'
                });
                
                input.value = '';
                scrollToBottom();
            } catch (error) {
                console.error('Send group message error:', error);
                alert('Failed to send message');
            }
        }

        function startEditMessage(messageId, currentText) {
            editingMessageId = messageId;
            render();
            const input = document.getElementById('messageInput');
            if (input) {
                input.value = currentText;
                input.focus();
            }
        }

        function cancelEditMessage() {
            editingMessageId = null;
            render();
        }

        async function saveEditMessage() {
            const input = document.getElementById('messageInput');
            const newText = input.value.trim();
            
            if (!newText || !editingMessageId) return;

            try {
                await db.collection('messages').doc(editingMessageId).update({
                    text: newText,
                    edited: true,
                    editedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                editingMessageId = null;
                input.value = '';
                render();
                scrollToBottom();
            } catch (error) {
                console.error('Edit message error:', error);
                alert('Failed to edit message');
            }
        }

        async function deleteMessage(messageId) {
            if (!confirm('Delete this message?')) return;

            try {
                await db.collection('messages').doc(messageId).delete();
            } catch (error) {
                console.error('Delete message error:', error);
                alert('Failed to delete message');
            }
        }

        // Friend functions
        async function showAddFriend() {
            const username = prompt('Enter username to add:');
            if (!username) return;
            
            if (username === currentUser.username) {
                alert('You cannot add yourself as a friend');
                return;
            }
            
            try {
                const userQuery = await db.collection('users').where('username', '==', username).get();
                if (userQuery.empty) {
                    alert('User not found');
                    return;
                }
                
                const existingFriend = friends.find(f => f.friendUsername === username);
                if (existingFriend) {
                    alert('You are already friends with this user');
                    return;
                }
                
                const existingRequest = friendRequests.find(r => 
                    (r.from === currentUser.username && r.to === username && r.status === 'pending') ||
                    (r.to === currentUser.username && r.from === username && r.status === 'pending')
                );
                if (existingRequest) {
                    alert('A friend request already exists between you and this user');
                    return;
                }
                
                await db.collection('friendRequests').add({
                    from: currentUser.username,
                    to: username,
                    status: 'pending',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                alert('Friend request sent!');
            } catch (error) {
                console.error('Friend request error:', error);
                alert('Failed to send friend request');
            }
        }

        async function acceptFriendRequest(requestId, fromUsername) {
            try {
                await db.collection('friendRequests').doc(requestId).update({
                    status: 'accepted'
                });
                
                await db.collection('friends').add({
                    user1: currentUser.username,
                    user2: fromUsername,
                    streak: 0,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                alert('Friend request accepted!');
                goHome();
            } catch (error) {
                console.error('Accept friend request error:', error);
                alert('Failed to accept friend request');
            }
        }

        async function rejectFriendRequest(requestId) {
            try {
                await db.collection('friendRequests').doc(requestId).update({
                    status: 'rejected'
                });
                goHome();
            } catch (error) {
                console.error('Reject friend request error:', error);
                alert('Failed to reject friend request');
            }
        }

        // Group functions
        async function createGroupWithMembers() {
            const groupName = document.getElementById('groupNameInput').value.trim();
            const groupBio = document.getElementById('groupBioInput').value.trim();
            
            if (!groupName) {
                alert('Please enter a group name');
                return;
            }

            const checkboxes = document.querySelectorAll('input[type="checkbox"]:checked');
            const selectedMembers = Array.from(checkboxes).map(cb => cb.value);
            
            if (selectedMembers.length === 0) {
                alert('Please select at least one member');
                return;
            }

            try {
                await db.collection('groups').add({
                    name: groupName,
                    bio: groupBio || null,
                    creator: currentUser.username,
                    members: [currentUser.username, ...selectedMembers],
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                alert('Group created!');
                showAllGroups();
            } catch (error) {
                console.error('Create group error:', error);
                alert('Failed to create group');
            }
        }

        async function editGroupInfo() {
            const newName = prompt('Enter
                                   new group name:', selectedGroup.name);
            if (!newName || newName === selectedGroup.name) {
                const newBio = prompt('Enter new group bio:', selectedGroup.bio || '');
                if (newBio !== null && newBio !== selectedGroup.bio) {
                    try {
                        await db.collection('groups').doc(selectedGroup.id).update({
                            bio: newBio
                        });
                        alert('Group bio updated!');
                        showGroupInfo();
                    } catch (error) {
                        console.error('Update group bio error:', error);
                        alert('Failed to update group bio');
                    }
                }
                return;
            }

            try {
                await db.collection('groups').doc(selectedGroup.id).update({
                    name: newName
                });
                
                const newBio = prompt('Enter new group bio:', selectedGroup.bio || '');
                if (newBio !== null) {
                    await db.collection('groups').doc(selectedGroup.id).update({
                        bio: newBio
                    });
                }
                
                alert('Group info updated!');
                showGroupInfo();
            } catch (error) {
                console.error('Update group error:', error);
                alert('Failed to update group info');
            }
        }

        async function showAddGroupMembers() {
            const availableFriends = friends.filter(f => 
                !selectedGroup.members.includes(f.friendUsername)
            );

            if (availableFriends.length === 0) {
                alert('All your friends are already in this group');
                return;
            }

            const membersList = availableFriends.map(f => f.friendUsername).join('\n');
            const username = prompt(`Select a friend to add:\n\n${membersList}\n\nEnter username:`);
            
            if (!username) return;

            if (!availableFriends.find(f => f.friendUsername === username)) {
                alert('User not found in your friends list or already in group');
                return;
            }

            try {
                await db.collection('groups').doc(selectedGroup.id).update({
                    members: firebase.firestore.FieldValue.arrayUnion(username)
                });
                alert('Member added!');
                showGroupInfo();
            } catch (error) {
                console.error('Add member error:', error);
                alert('Failed to add member');
            }
        }

        async function removeGroupMember(username) {
            if (!confirm(`Remove @${username} from the group?`)) return;

            try {
                await db.collection('groups').doc(selectedGroup.id).update({
                    members: firebase.firestore.FieldValue.arrayRemove(username)
                });
                alert('Member removed!');
                showGroupInfo();
            } catch (error) {
                console.error('Remove member error:', error);
                alert('Failed to remove member');
            }
        }

        async function leaveGroup() {
            if (!confirm('Are you sure you want to leave this group?')) return;

            try {
                await db.collection('groups').doc(selectedGroup.id).update({
                    members: firebase.firestore.FieldValue.arrayRemove(currentUser.username)
                });
                alert('You left the group');
                goHome();
            } catch (error) {
                console.error('Leave group error:', error);
                alert('Failed to leave group');
            }
        }

        async function deleteGroup() {
            if (!confirm('Are you sure you want to delete this group? This cannot be undone.')) return;

            try {
                await db.collection('groups').doc(selectedGroup.id).delete();
                alert('Group deleted');
                goHome();
            } catch (error) {
                console.error('Delete group error:', error);
                alert('Failed to delete group');
            }
        }

        // Channel functions
        async function createChannel() {
            const channelName = document.getElementById('channelNameInput').value.trim();
            const channelDesc = document.getElementById('channelDescInput').value.trim();

            if (!channelName) {
                alert('Please enter a channel name');
                return;
            }

            try {
                await db.collection('channels').add({
                    name: channelName,
                    description: channelDesc || null,
                    creator: currentUser.username,
                    followers: [currentUser.username],
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                alert('Channel created!');
                showChannels();
            } catch (error) {
                console.error('Create channel error:', error);
                alert('Failed to create channel');
            }
        }

        async function toggleFollowChannel(channelId) {
            const channel = channels.find(c => c.id === channelId);
            if (!channel) return;

            const isFollowing = channel.followers && channel.followers.includes(currentUser.username);

            try {
                if (isFollowing) {
                    await db.collection('channels').doc(channelId).update({
                        followers: firebase.firestore.FieldValue.arrayRemove(currentUser.username)
                    });
                } else {
                    await db.collection('channels').doc(channelId).update({
                        followers: firebase.firestore.FieldValue.arrayUnion(currentUser.username)
                    });
                }
            } catch (error) {
                console.error('Toggle follow error:', error);
                alert('Failed to update follow status');
            }
        }

        async function postToChannel() {
            const input = document.getElementById('channelPostInput');
            const text = input ? input.value.trim() : '';
            
            if (!text || !selectedChannel) return;

            try {
                await db.collection('messages').add({
                    from: currentUser.username,
                    channelId: selectedChannel.id,
                    text: text,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    type: 'channel_post'
                });
                
                input.value = '';
            } catch (error) {
                console.error('Post to channel error:', error);
                alert('Failed to post');
            }
        }

        function filterChannels(searchTerm) {
            const term = searchTerm.toLowerCase();
            const filtered = channels.filter(c => 
                c.name.toLowerCase().includes(term) || 
                (c.description && c.description.toLowerCase().includes(term))
            );

            const channelsHtml = filtered.length === 0
                ? '<div class="text-center py-8 text-gray-500"><p>No channels found</p></div>'
                : filtered.map(channel => {
                    const isFollowing = channel.followers && channel.followers.includes(currentUser.username);
                    return `
                    <div class="bg-white p-4 border-b hover:bg-gray-50 transition">
                        <div class="flex items-center justify-between">
                            <div onclick="viewChannel('${channel.id}')" class="flex items-center gap-3 flex-1 cursor-pointer">
                                <div class="w-12 h-12 rounded-full bg-gradient-to-br from-purple-400 to-purple-600 flex items-center justify-center text-white text-2xl">
                                    ${icons.channel}
                                </div>
                                <div>
                                    <p class="font-semibold">${channel.name}</p>
                                    ${channel.description ? `<p class="text-xs text-gray-500">${channel.description}</p>` : ''}
                                    <p class="text-xs text-gray-400">${channel.followers ? channel.followers.length : 0} followers</p>
                                </div>
                            </div>
                            ${channel.creator !== currentUser.username ? `
                            <button onclick="toggleFollowChannel('${channel.id}')" 
                                class="${isFollowing ? 'bg-gray-200 text-gray-700' : 'bg-green-600 text-white'} px-4 py-2 rounded-full text-sm hover:opacity-80">
                                ${isFollowing ? 'Following' : 'Follow'}
                            </button>
                            ` : ''}
                        </div>
                    </div>
                `}).join('');

            document.getElementById('channelsList').innerHTML = channelsHtml;
        }

        // Story functions
        function captureImage() {
            document.getElementById('imageInput').click();
        }

        async function handleImageSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                // Check if posting story from home
                if (currentView === 'home') {
                    const isPublic = confirm('Make this story public?\n\nOK = Public (everyone can see)\nCancel = Private (only friends can see)');
                    await uploadStory(e.target.result, isPublic);
                } else {
                    await uploadToCloudinary(e.target.result);
                }
            };
            reader.readAsDataURL(file);
            event.target.value = '';
        }

        async function uploadStory(imageData, isPublic) {
            try {
                const blob = await fetch(imageData).then(r => r.blob());
                const formData = new FormData();
                formData.append('file', blob);
                formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
                formData.append('folder', 'godswillscorechat/stories');

                const response = await fetch(CLOUDINARY_UPLOAD_URL, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                await db.collection('stories').add({
                    username: currentUser.username,
                    imageUrl: data.secure_url,
                    publicId: data.public_id,
                    isPublic: isPublic,
                    viewedBy: [],
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    expiresAt: firebase.firestore.Timestamp.fromDate(new Date(Date.now() + 24 * 60 * 60 * 1000))
                });

                alert(`Story posted as ${isPublic ? 'PUBLIC' : 'PRIVATE'}! üéâ`);
                render();
            } catch (error) {
                console.error('Upload story error:', error);
                alert('Failed to upload story');
            }
        }

        async function uploadToCloudinary(imageData) {
            if (!selectedFriend && !selectedGroup && !selectedChannel) {
                alert('Please select a friend, group, or channel first');
                return;
            }

            try {
                const blob = await fetch(imageData).then(r => r.blob());
                const formData = new FormData();
                formData.append('file', blob);
                formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
                formData.append('folder', 'godswillscorechat');

                const response = await fetch(CLOUDINARY_UPLOAD_URL, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (selectedChannel) {
                    await db.collection('messages').add({
                        from: currentUser.username,
                        channelId: selectedChannel.id,
                        imageUrl: data.secure_url,
                        publicId: data.public_id,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        type: 'channel_post'
                    });
                } else if (selectedGroup) {
                    await db.collection('messages').add({
                        from: currentUser.username,
                        groupId: selectedGroup.id,
                        imageUrl: data.secure_url,
                        publicId: data.public_id,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        type: 'group_snap'
                    });
                } else {
                    await db.collection('messages').add({
                        from: currentUser.username,
                        to: selectedFriend.friendUsername,
                        imageUrl: data.secure_url,
                        publicId: data.public_id,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        type: 'snap'
                    });
                }

                alert('Photo sent! üéâ');
                scrollToBottom();
            } catch (error) {
                console.error('Upload error:', error);
                alert('Failed to upload image');
            }
        }

        async function viewStory(storyId) {
            const story = stories.find(s => s.id === storyId);
            if (!story) return;

            // Track view if not own story and not already viewed
            if (story.username !== currentUser.username) {
                const viewedBy = story.viewedBy || [];
                if (!viewedBy.includes(currentUser.username)) {
                    try {
                        await db.collection('stories').doc(storyId).update({
                            viewedBy: firebase.firestore.FieldValue.arrayUnion(currentUser.username)
                        });
                    } catch (error) {
                        console.error('Track view error:', error);
                    }
                }
            }
            
            const modal = document.getElementById('storyModal');
            const content = document.getElementById('storyContent');
            
            const isMyStory = story.username === currentUser.username;
            const viewCount = story.viewedBy ? story.viewedBy.length : 0;
            
            content.innerHTML = `
                <div class="relative w-full max-w-lg h-full flex flex-col">
                    <div class="absolute top-4 left-4 right-4 z-10 flex items-center justify-between">
                        <div class="flex items-center gap-2 bg-black bg-opacity-50 px-3 py-2 rounded-full">
                            <div class="w-8 h-8 rounded-full bg-gradient-to-br from-blue-400 to-blue-600 flex items-center justify-center text-white text-sm">
                                ${icons.user}
                            </div>
                            <span class="text-white font-semibold">@${story.username}</span>
                            ${!story.isPublic ? `<span class="text-white">${icons.lock}</span>` : ''}
                        </div>
                        <div class="flex items-center gap-2">
                            ${isMyStory ? `
                            <div class="bg-black bg-opacity-50 px-3 py-2 rounded-full flex items-center gap-1">
                                <span class="text-white">${icons.eye}</span>
                                <span class="text-white text-sm font-semibold">${viewCount}</span>
                            </div>
                            <button onclick="deleteStory('${story.id}')" class="bg-red-500 bg-opacity-80 px-3 py-2 rounded-full text-white text-sm font-semibold hover:bg-opacity-100">
                                ${icons.delete} Delete
                            </button>
                            ` : ''}
                            <span class="text-white text-sm bg-black bg-opacity-50 px-3 py-2 rounded-full">
                                ${formatTime(story.timestamp)}
                            </span>
                        </div>
                    </div>
                    <div class="flex-1 flex items-center justify-center">
                        <img src="${story.imageUrl}" alt="Story" class="max-w-full max-h-full object-contain">
                    </div>
                </div>
            `;
            
            modal.classList.remove('hidden');
        }

        function closeStory() {
            const modal = document.getElementById('storyModal');
            modal.classList.add('hidden');
        }

        async function deleteStory(storyId) {
            if (!confirm('Delete this story?')) return;

            try {
                await db.collection('stories').doc(storyId).delete();
                closeStory();
                alert('Story deleted!');
            } catch (error) {
                console.error('Delete story error:', error);
                alert('Failed to delete story');
            }
        }

        // Firebase listeners
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                const userDoc = await db.collection('users').doc(user.uid).get();
                currentUser = userDoc.data();
                currentView = 'home';
                
                // Listen to friends where current user is user1
                db.collection('friends')
                    .where('user1', '==', currentUser.username)
                    .onSnapshot(snapshot => {
                        friends = snapshot.docs.map(doc => ({
                            id: doc.id,
                            friendUsername: doc.data().user2,
                            streak: doc.data().streak || 0
                        }));
                        
                        // Listen to friends where current user is user2
                        db.collection('friends')
                            .where('user2', '==', currentUser.username)
                            .onSnapshot(snapshot2 => {
                                const moreFriends = snapshot2.docs.map(doc => ({
                                    id: doc.id,
                                    friendUsername: doc.data().user1,
                                    streak: doc.data().streak || 0
                                }));
                                friends = [...friends, ...moreFriends];
                                render();
                            });
                        
                        render();
                    });
                
                // Listen to all messages (will be filtered in render functions)
                db.collection('messages').onSnapshot(snapshot => {
                    messages = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    render();
                    if (currentView === 'chat' || currentView === 'groupChat') {
                        scrollToBottom();
                    }
                });
                
                // Listen to friend requests
                db.collection('friendRequests').onSnapshot(snapshot => {
                    friendRequests = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    render();
                });
                
                // Listen to groups
                db.collection('groups')
                    .where('members', 'array-contains', currentUser.username)
                    .onSnapshot(snapshot => {
                        groups = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        render();
                    });
                
                // Listen to stories
                db.collection('stories')
                    .where('expiresAt', '>', firebase.firestore.Timestamp.now())
                    .onSnapshot(snapshot => {
                        stories = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        })).sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                        render();
                    });

                // Listen to channels
                db.collection('channels').onSnapshot(snapshot => {
                    channels = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    render();
                });

                // Listen to all users
                db.collection('users').onSnapshot(snapshot => {
                    allUsers = snapshot.docs.map(doc => doc.data());
                });
                
                render();
            } else {
                currentUser = null;
                currentView = 'auth';
                friends = [];
                messages = [];
                groups = [];
                friendRequests = [];
                stories = [];
                channels = [];
                allUsers = [];
                editingMessageId = null;
                render();
            }
        });

        render();
    </script>
</body>
</html>
