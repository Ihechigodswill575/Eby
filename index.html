<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Godswillscorechatüåêüßä</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</head>
<body class="bg-gray-100">
    <div id="app"></div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBzUELxbbaL6Wb_M1uNhjwlZHVTorN9XJs",
            authDomain: "my-whatsapp-2c1af.firebaseapp.com",
            projectId: "my-whatsapp-2c1af",
            storageBucket: "my-whatsapp-2c1af.firebasestorage.app",
            messagingSenderId: "1089455460888",
            appId: "1:1089455460888:web:d0c8dea185ba6769ebe96d"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        const CLOUDINARY_CLOUD_NAME = 'dzxckgbzp';
        const CLOUDINARY_UPLOAD_PRESET = 'godswillscorechat';
        const CLOUDINARY_UPLOAD_URL = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`;

        let currentUser = null;
        let currentView = 'auth';
        let selectedFriend = null;
        let selectedGroup = null;
        let messages = [];
        let friends = [];
        let groups = [];
        let friendRequests = [];
        let stories = [];

        const icons = {
            camera: 'üì∑',
            send: 'üì§',
            user: 'üë§',
            home: 'üè†',
            plus: '‚ûï',
            close: '‚úñÔ∏è',
            logout: 'üö™',
            fire: 'üî•'
        };

        function render() {
            const app = document.getElementById('app');
            if (!currentUser) {
                app.innerHTML = renderAuth();
            } else if (currentView === 'home') {
                app.innerHTML = renderHome();
            } else if (currentView === 'chat') {
                app.innerHTML = renderChat();
            } else if (currentView === 'requests') {
                app.innerHTML = renderFriendRequests();
            } else if (currentView === 'groups') {
                app.innerHTML = renderGroups();
            } else if (currentView === 'groupChat') {
                app.innerHTML = renderGroupChat();
            }
        }

        function renderAuth() {
            return `
                <div class="flex items-center justify-center min-h-screen bg-gradient-to-br from-yellow-300 via-yellow-400 to-yellow-500">
                    <div class="bg-white p-8 rounded-3xl shadow-2xl max-w-md w-full mx-4">
                        <h1 class="text-4xl font-bold mb-2 text-yellow-500 text-center">Godswillscorechatüó®</h1>
                        <p class="text-gray-600 mb-6 text-center">Share moments with real people</p>
                        
                        <div class="space-y-4">
                            <input type="text" id="username" placeholder="Username" 
                                class="w-full px-4 py-3 border rounded-full focus:outline-none focus:ring-2 focus:ring-yellow-500">
                            <input type="password" id="password" placeholder="Password" 
                                class="w-full px-4 py-3 border rounded-full focus:outline-none focus:ring-2 focus:ring-yellow-500">
                            
                            <div id="authError" class="text-red-500 text-sm text-center hidden"></div>
                            
                            <button onclick="handleLogin()" 
                                class="w-full bg-yellow-500 text-white py-3 px-6 rounded-full font-semibold hover:bg-yellow-600 transition">
                                Log In
                            </button>
                            <button onclick="handleSignUp()" 
                                class="w-full bg-gray-200 text-gray-700 py-3 px-6 rounded-full font-semibold hover:bg-gray-300 transition">
                                Sign Up
                            </button>
                        </div>
                        
                        <div class="mt-6 p-4 bg-yellow-50 rounded-xl">
                            <p class="text-xs text-gray-600">
                                <strong>‚úÖ Real-time Chat</strong><br/>
                                ‚Ä¢ Friend requests & Groups<br/>
                                ‚Ä¢ Firebase & Cloudinary
                            </p>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderHome() {
            const pendingRequestsCount = friendRequests.filter(r => r.to === currentUser.username && r.status === 'pending').length;
            
            const friendsHtml = friends.length === 0 
                ? '<div class="text-center py-8 text-gray-500"><p>No friends yet. Send friend requests to start chatting!</p></div>'
                : friends.map(friend => `
                    <div onclick="openChat('${friend.id}')" 
                        class="bg-white p-4 rounded-xl shadow hover:shadow-md transition cursor-pointer">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 rounded-full bg-gradient-to-br from-blue-400 to-blue-600 flex items-center justify-center text-white text-2xl">
                                    ${icons.user}
                                </div>
                                <div>
                                    <p class="font-semibold">@${friend.friendUsername}</p>
                                    <p class="text-sm text-gray-500">Tap to chat</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-2xl">${icons.fire}</span>
                                <span class="font-bold text-yellow-500">${friend.streak || 0}</span>
                            </div>
                        </div>
                    </div>
                `).join('');

            const groupsHtml = groups.slice(0, 3).map(group => `
                <div onclick="openGroupChat('${group.id}')" 
                    class="bg-white p-4 rounded-xl shadow hover:shadow-md transition cursor-pointer">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-full bg-gradient-to-br from-purple-400 to-purple-600 flex items-center justify-center text-white text-2xl">
                            üë•
                        </div>
                        <div>
                            <p class="font-semibold">${group.name}</p>
                            <p class="text-sm text-gray-500">${group.members.length} members</p>
                        </div>
                    </div>
                </div>
            `).join('');

            const storiesHtml = stories.map(story => `
                <button onclick="viewStory('${story.id}')" class="flex flex-col items-center flex-shrink-0">
                    <div class="w-16 h-16 rounded-full bg-gradient-to-br from-pink-400 to-purple-600 p-0.5">
                        <img src="${story.imageUrl}" 
                            alt="Story by @${story.username}" 
                            class="w-full h-full rounded-full object-cover border-2 border-white">
                    </div>
                    <span class="text-xs mt-1 max-w-[64px] truncate">@${story.username}</span>
                </button>
            `).join('');

            return `
                <div class="flex flex-col h-screen bg-gray-100">
                    <div class="bg-yellow-500 text-white p-4 shadow-lg">
                        <div class="flex items-center justify-between max-w-6xl mx-auto">
                            <h1 class="text-2xl font-bold">Godswillscorechatüó®</h1>
                            <div class="flex items-center gap-4">
                                <button onclick="showFriendRequests()" class="relative p-2 bg-yellow-600 rounded-full hover:bg-yellow-700 transition">
                                    üì¨
                                    ${pendingRequestsCount > 0 ? `<span class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">${pendingRequestsCount}</span>` : ''}
                                </button>
                                <span class="text-sm font-semibold">@${currentUser.username}</span>
                                <button onclick="handleLogout()" 
                                    class="p-2 bg-yellow-600 rounded-full hover:bg-yellow-700 transition">
                                    ${icons.logout}
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="flex-1 overflow-y-auto p-4 max-w-6xl mx-auto w-full">
                        <div class="mb-6">
                            <h2 class="text-xl font-bold mb-3">Stories</h2>
                            <div class="flex gap-4 overflow-x-auto pb-2">
                                <button onclick="captureImage()" class="flex flex-col items-center flex-shrink-0">
                                    <div class="w-16 h-16 rounded-full bg-gradient-to-br from-yellow-400 to-yellow-600 flex items-center justify-center border-4 border-white shadow-lg text-white text-2xl">
                                        ${icons.plus}
                                    </div>
                                    <span class="text-xs mt-1">Add Story</span>
                                </button>
                                ${storiesHtml}
                            </div>
                        </div>

                        ${groups.length > 0 ? `
                        <div class="mb-6">
                            <div class="flex items-center justify-between mb-3">
                                <h2 class="text-xl font-bold">Groups</h2>
                                <button onclick="showAllGroups()" class="text-yellow-500 text-sm hover:underline">
                                    View All
                                </button>
                            </div>
                            ${groupsHtml}
                        </div>
                        ` : ''}

                        <div>
                            <div class="flex items-center justify-between mb-3">
                                <h2 class="text-xl font-bold">Friends</h2>
                                <button onclick="showAddFriend()" 
                                    class="bg-yellow-500 text-white px-4 py-2 rounded-full text-sm hover:bg-yellow-600">
                                    ${icons.plus} Add Friend
                                </button>
                            </div>
                            ${friendsHtml}
                        </div>
                    </div>

                    <div class="bg-white border-t p-2">
                        <div class="flex justify-around max-w-6xl mx-auto">
                            <button onclick="goHome()" class="p-3 rounded-full bg-yellow-100">
                                <span class="text-2xl">${icons.home}</span>
                            </button>
                            <button onclick="showAllGroups()" class="p-3 rounded-full">
                                <span class="text-2xl">üë•</span>
                            </button>
                            <button onclick="captureImage()" class="p-3 rounded-full">
                                <span class="text-2xl">${icons.camera}</span>
                            </button>
                        </div>
                    </div>
                </div>

                <input type="file" id="imageInput" accept="image/*" style="display:none;" onchange="handleImageSelect(event)">
                
                <div id="storyModal" class="hidden fixed inset-0 bg-black z-50 flex items-center justify-center">
                    <button onclick="closeStory()" class="absolute top-4 right-4 text-white text-3xl z-10">
                        ${icons.close}
                    </button>
                    <div id="storyContent" class="w-full h-full flex items-center justify-center">
                    </div>
                </div>
            `;
        }

        function renderChat() {
            if (!selectedFriend) return '';

            const chatMessages = messages
                .filter(m => 
                    (m.from === currentUser.username && m.to === selectedFriend.friendUsername) ||
                    (m.to === currentUser.username && m.from === selectedFriend.friendUsername)
                )
                .sort((a, b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0));

            const messagesHtml = chatMessages.map(msg => {
                const isFromMe = msg.from === currentUser.username;
                if (msg.imageUrl) {
                    return `
                        <div class="flex ${isFromMe ? 'justify-end' : 'justify-start'} mb-2">
                            <div class="max-w-[70%]">
                                <img src="${msg.imageUrl}" alt="Snap" class="rounded-2xl shadow-lg w-full">
                            </div>
                        </div>
                    `;
                } else {
                    return `
                        <div class="flex ${isFromMe ? 'justify-end' : 'justify-start'} mb-2">
                            <div class="max-w-[70%] px-4 py-2 rounded-2xl ${isFromMe ? 'bg-yellow-500 text-white rounded-br-sm' : 'bg-gray-200 text-gray-800 rounded-bl-sm'}">
                                <p class="break-words">${msg.text}</p>
                            </div>
                        </div>
                    `;
                }
            }).join('');

            return `
                <div class="flex flex-col h-screen bg-gray-100">
                    <div class="bg-white p-4 shadow flex items-center gap-3">
                        <button onclick="goHome()" class="text-gray-600 hover:text-gray-800 text-2xl">
                            ‚Üê
                        </button>
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-400 to-blue-600 flex items-center justify-center text-white text-xl">
                            ${icons.user}
                        </div>
                        <div>
                            <p class="font-semibold">@${selectedFriend.friendUsername}</p>
                            <p class="text-xs text-gray-500">${icons.fire} ${selectedFriend.streak || 0} day streak</p>
                        </div>
                    </div>

                    <div id="chatMessages" class="flex-1 overflow-y-auto p-4 flex flex-col">
                        ${messagesHtml || '<div class="flex-1 flex items-center justify-center"><p class="text-center text-gray-500">No messages yet. Send a snap!</p></div>'}
                    </div>

                    <div class="bg-white p-4 border-t">
                        <div class="flex gap-2 items-center">
                            <button onclick="captureImage()" 
                                class="p-3 bg-yellow-500 text-white rounded-full hover:bg-yellow-600 text-xl flex-shrink-0">
                                ${icons.camera}
                            </button>
                            <input type="text" id="messageInput" placeholder="Send a message..." 
                                class="flex-1 px-4 py-3 border rounded-full focus:outline-none focus:ring-2 focus:ring-yellow-500"
                                onkeypress="if(event.key==='Enter') sendMessage()">
                            <button onclick="sendMessage()" 
                                class="p-3 bg-yellow-500 text-white rounded-full hover:bg-yellow-600 text-xl flex-shrink-0">
                                ${icons.send}
                            </button>
                        </div>
                    </div>
                </div>

                <input type="file" id="imageInput" accept="image/*" style="display:none;" onchange="handleImageSelect(event)">
            `;
        }

        function renderFriendRequests() {
            const pendingRequests = friendRequests.filter(r => r.to === currentUser.username && r.status === 'pending');
            
            const requestsHtml = pendingRequests.length === 0
                ? '<div class="text-center py-8 text-gray-500"><p>No pending friend requests</p></div>'
                : pendingRequests.map(request => `
                    <div class="bg-white p-4 rounded-xl shadow">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 rounded-full bg-gradient-to-br from-blue-400 to-blue-600 flex items-center justify-center text-white text-2xl">
                                    ${icons.user}
                                </div>
                                <div>
                                    <p class="font-semibold">@${request.from}</p>
                                    <p class="text-sm text-gray-500">wants to be friends</p>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="acceptFriendRequest('${request.id}', '${request.from}')" 
                                    class="bg-yellow-500 text-white px-4 py-2 rounded-full text-sm hover:bg-yellow-600">
                                    Accept
                                </button>
                                <button onclick="rejectFriendRequest('${request.id}')" 
                                    class="bg-gray-200 text-gray-700 px-4 py-2 rounded-full text-sm hover:bg-gray-300">
                                    Decline
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');

            return `
                <div class="flex flex-col h-screen bg-gray-100">
                    <div class="bg-white p-4 shadow flex items-center gap-3">
                        <button onclick="goHome()" class="text-gray-600 hover:text-gray-800 text-2xl">
                            ${icons.close}
                        </button>
                        <h2 class="text-xl font-bold">Friend Requests</h2>
                    </div>

                    <div class="flex-1 overflow-y-auto p-4 space-y-3">
                        ${requestsHtml}
                    </div>
                </div>
            `;
        }

        function renderGroups() {
            const groupsHtml = groups.length === 0
                ? '<div class="text-center py-8 text-gray-500"><p>No groups yet. Create one to start!</p></div>'
                : groups.map(group => `
                    <div onclick="openGroupChat('${group.id}')" 
                        class="bg-white p-4 rounded-xl shadow hover:shadow-md transition cursor-pointer">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 rounded-full bg-gradient-to-br from-purple-400 to-purple-600 flex items-center justify-center text-white text-2xl">
                                üë•
                            </div>
                            <div>
                                <p class="font-semibold">${group.name}</p>
                                <p class="text-sm text-gray-500">${group.members.length} members</p>
                            </div>
                        </div>
                    </div>
                `).join('');

            return `
                <div class="flex flex-col h-screen bg-gray-100">
                    <div class="bg-white p-4 shadow flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <button onclick="goHome()" class="text-gray-600 hover:text-gray-800 text-2xl">
                                ${icons.close}
                            </button>
                            <h2 class="text-xl font-bold">Groups</h2>
                        </div>
                        <button onclick="createGroup()" 
                            class="bg-yellow-500 text-white px-4 py-2 rounded-full text-sm hover:bg-yellow-600">
                            ${icons.plus} Create Group
                        </button>
                    </div>

                    <div class="flex-1 overflow-y-auto p-4 space-y-3">
                        ${groupsHtml}
                    </div>
                </div>
            `;
        }

        function renderGroupChat() {
            if (!selectedGroup) return '';

            const chatMessages = messages
                .filter(m => m.groupId === selectedGroup.id)
                .sort((a, b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0));

            const messagesHtml = chatMessages.map(msg => {
                const isFromMe = msg.from === currentUser.username;
                if (msg.imageUrl) {
                    return `
                        <div class="flex ${isFromMe ? 'justify-end' : 'justify-start'} mb-2">
                            <div class="max-w-[70%]">
                                ${!isFromMe ? `<p class="text-xs text-gray-500 mb-1 ml-2">@${msg.from}</p>` : ''}
                                <img src="${msg.imageUrl}" alt="Snap" class="rounded-2xl shadow-lg w-full">
                            </div>
                        </div>
                    `;
                } else {
                    return `
                        <div class="flex ${isFromMe ? 'justify-end' : 'justify-start'} mb-2">
                            <div class="max-w-[70%]">
                                ${!isFromMe ? `<p class="text-xs text-gray-500 mb-1 ml-2">@${msg.from}</p>` : ''}
                                <div class="px-4 py-2 rounded-2xl ${isFromMe ? 'bg-yellow-500 text-white rounded-br-sm' : 'bg-gray-200 text-gray-800 rounded-bl-sm'}">
                                    <p class="break-words">${msg.text}</p>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }).join('');

            return `
                <div class="flex flex-col h-screen bg-gray-100">
                    <div class="bg-white p-4 shadow flex items-center gap-3">
                        <button onclick="goHome()" class="text-gray-600 hover:text-gray-800 text-2xl">
                            ‚Üê
                        </button>
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-purple-400 to-purple-600 flex items-center justify-center text-white text-xl">
                            üë•
                        </div>
                        <div>
                            <p class="font-semibold">${selectedGroup.name}</p>
                            <p class="text-xs text-gray-500">${selectedGroup.members.length} members</p>
                        </div>
                    </div>

                    <div id="chatMessages" class="flex-1 overflow-y-auto p-4 flex flex-col">
                        ${messagesHtml || '<div class="flex-1 flex items-center justify-center"><p class="text-center text-gray-500">No messages yet. Start the conversation!</p></div>'}
                    </div>

                    <div class="bg-white p-4 border-t">
                        <div class="flex gap-2 items-center">
                            <button onclick="captureImage()" 
                                class="p-3 bg-yellow-500 text-white rounded-full hover:bg-yellow-600 text-xl flex-shrink-0">
                                ${icons.camera}
                            </button>
                            <input type="text" id="messageInput" placeholder="Send a message..." 
                                class="flex-1 px-4 py-3 border rounded-full focus:outline-none focus:ring-2 focus:ring-yellow-500"
                                onkeypress="if(event.key==='Enter') sendGroupMessage()">
                            <button onclick="sendGroupMessage()" 
                                class="p-3 bg-yellow-500 text-white rounded-full hover:bg-yellow-600 text-xl flex-shrink-0">
                                ${icons.send}
                            </button>
                        </div>
                    </div>
                </div>

                <input type="file" id="imageInput" accept="image/*" style="display:none;" onchange="handleImageSelect(event)">
            `;
        }

        async function handleSignUp() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('authError');

            if (!username || !password) {
                errorDiv.textContent = 'Please enter username and password';
                errorDiv.classList.remove('hidden');
                return;
            }

            try {
                const usernameQuery = await db.collection('users').where('username', '==', username).get();
                if (!usernameQuery.empty) {
                    errorDiv.textContent = 'Username already taken';
                    errorDiv.classList.remove('hidden');
                    return;
                }

                const email = `${username}@godswillscorechat.app`;
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                
                await db.collection('users').doc(userCredential.user.uid).set({
                    uid: userCredential.user.uid,
                    username: username,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            } catch (error) {
                errorDiv.textContent = error.message;
                errorDiv.classList.remove('hidden');
            }
        }

        async function handleLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('authError');

            if (!username || !password) {
                errorDiv.textContent = 'Please enter username and password';
                errorDiv.classList.remove('hidden');
                return;
            }

            try {
                const usernameQuery = await db.collection('users').where('username', '==', username).get();
                if (usernameQuery.empty) {
                    errorDiv.textContent = 'Username not found';
                    errorDiv.classList.remove('hidden');
                    return;
                }

                const email = `${username}@godswillscorechat.app`;
                await auth.signInWithEmailAndPassword(email, password);
            } catch (error) {
                errorDiv.textContent = 'Incorrect password';
                errorDiv.classList.remove('hidden');
            }
        }

        async function handleLogout() {
            await auth.signOut();
        }

        function goHome() {
            currentView = 'home';
            selectedFriend = null;
            selectedGroup = null;
            render();
        }

        function showFriendRequests() {
            currentView = 'requests';
            render();
        }

        function showAllGroups() {
            currentView = 'groups';
            render();
        }

        function scrollToBottom() {
            setTimeout(() => {
                const chatDiv = document.getElementById('chatMessages');
                if (chatDiv) {
                    chatDiv.scrollTop = chatDiv.scrollHeight;
                }
            }, 100);
        }

        function openChat(friendId) {
            selectedFriend = friends.find(f => f.id === friendId);
            selectedGroup = null;
            currentView = 'chat';
            render();
            scrollToBottom();
        }

        function openGroupChat(groupId) {
            selectedGroup = groups.find(g => g.id === groupId);
            selectedFriend = null;
            currentView = 'groupChat';
            render();
            scrollToBottom();
        }

        async function showAddFriend() {
            const username = prompt('Enter username to add:');
            if (!username) return;
            
            if (username === currentUser.username) {
                alert('You cannot add yourself as a friend');
                return;
            }
            
            try {
                const userQuery = await db.collection('users').where('username', '==', username).get();
                if (userQuery.empty) {
                    alert('User not found');
                    return;
                }
                
                const existingFriend = friends.find(f => f.friendUsername === username);
                if (existingFriend) {
                    alert('You are already friends with this user');
                    return;
                }
                
                const existingRequest = friendRequests.find(r => 
                    (r.from === currentUser.username && r.to === username && r.status === 'pending') ||
                    (r.to === currentUser.username && r.from === username && r.status === 'pending')
                );
                if (existingRequest) {
                    alert('A friend request already exists between you and this user');
                    return;
                }
                
                await db.collection('friendRequests').add({
                    from: currentUser.username,
                    to: username,
                    status: 'pending',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                alert('Friend request sent!');
            } catch (error) {
                console.error('Friend request error:', error);
                alert('Failed to send friend request');
            }
        }

        async function acceptFriendRequest(requestId, fromUsername) {
            try {
                await db.collection('friendRequests').doc(requestId).update({
                    status: 'accepted'
                });
                
                await db.collection('friends').add({
                    user1: currentUser.username,
                    user2: fromUsername,
                    streak: 0,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                alert('Friend request accepted!');
                goHome();
            } catch (error) {
                console.error('Accept friend request error:', error);
                alert('Failed to accept friend request');
            }
        }

        async function rejectFriendRequest(requestId) {
            try {
                await db.collection('friendRequests').doc(requestId).update({
                    status: 'rejected'
                });
                goHome();
            } catch (error) {
                console.error('Reject friend request error:', error);
                alert('Failed to reject friend request');
            }
        }

        async function createGroup() {
            const groupName = prompt('Enter group name:');
            if (!groupName) return;
            
            try {
                await db.collection('groups').add({
                    name: groupName,
                    creator: currentUser.username,
                    members: [currentUser.username],
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                alert('Group created!');
                showAllGroups();
            } catch (error) {
                console.error('Create group error:', error);
                alert('Failed to create group');
            }
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            
            if (!text || !selectedFriend) return;

            try {
                await db.collection('messages').add({
                    from: currentUser.username,
                    to: selectedFriend.friendUsername,
                    text: text,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    type: 'text'
                });
                
                input.value = '';
                scrollToBottom();
            } catch (error) {
                console.error('Send message error:', error);
                alert('Failed to send message');
            }
        }

        async function sendGroupMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            
            if (!text || !selectedGroup) return;

            try {
                await db.collection('messages').add({
                    from: currentUser.username,
                    groupId: selectedGroup.id,
                    text: text,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    type: 'group_text'
                });
                
                input.value = '';
                scrollToBottom();
            } catch (error) {
                console.error('Send group message error:', error);
                alert('Failed to send message');
            }
        }

        function captureImage() {
            document.getElementById('imageInput').click();
        }

        async function handleImageSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                await uploadToCloudinary(e.target.result);
            };
            reader.readAsDataURL(file);
            event.target.value = '';
        }

        async function uploadToCloudinary(imageData) {
            if (currentView === 'home') {
                try {
                    const blob = await fetch(imageData).then(r => r.blob());
                    const formData = new FormData();
                    formData.append('file', blob);
                    formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
                    formData.append('folder', 'godswillscorechat/stories');

                    const response = await fetch(CLOUDINARY_UPLOAD_URL, {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();

                    await db.collection('stories').add({
                        username: currentUser.username,
                        imageUrl: data.secure_url,
                        publicId: data.public_id,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        expiresAt: new Date(Date.now() + 24 * 60 * 60 * 1000)
                    });

                    alert('Story posted! üéâ');
                } catch (error) {
                    console.error('Upload error:', error);
                    alert('Failed to upload story');
                }
                return;
            }

            if (!selectedFriend && !selectedGroup) {
                alert('Please select a friend or group first');
                return;
            }

            try {
                const blob = await fetch(imageData).then(r => r.blob());
                const formData = new FormData();
                formData.append('file', blob);
                formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
                formData.append('folder', 'godswillscorechat');

                const response = await fetch(CLOUDINARY_UPLOAD_URL, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (selectedGroup) {
                    await db.collection('messages').add({
                        from: currentUser.username,
                        groupId: selectedGroup.id,
                        imageUrl: data.secure_url,
                        publicId: data.public_id,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        type: 'group_snap'
                    });
                } else {
                    await db.collection('messages').add({
                        from: currentUser.username,
                        to: selectedFriend.friendUsername,
                        imageUrl: data.secure_url,
                        publicId: data.public_id,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        type: 'snap'
                    });
                }

                alert('Snap sent! üéâ');
                scrollToBottom();
            } catch (error) {
                console.error('Upload error:', error);
                alert('Failed to upload image');
            }
        }

        function viewStory(storyId) {
            const story = stories.find(s => s.id === storyId);
            if (!story) return;
            
            const modal = document.getElementById('storyModal');
            const content = document.getElementById('storyContent');
            
            content.innerHTML = `
                <div class="relative w-full max-w-lg">
                    <div class="absolute top-4 left-4 z-10 bg-black bg-opacity-50 px-3 py-2 rounded-full">
                        <span class="text-white font-semibold">@${story.username}</span>
                    </div>
                    <img src="${story.imageUrl}" alt="Story" class="w-full h-auto max-h-screen object-contain">
                </div>
            `;
            
            modal.classList.remove('hidden');
        }

        function closeStory() {
            const modal = document.getElementById('storyModal');
            modal.classList.add('hidden');
        }

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                const userDoc = await db.collection('users').doc(user.uid).get();
                currentUser = userDoc.data();
                currentView = 'home';
                
                db.collection('friends')
                    .where('user1', '==', currentUser.username)
                    .onSnapshot(snapshot => {
                        friends = snapshot.docs.map(doc => ({
                            id: doc.id,
                            friendUsername: doc.data().user2,
                            streak: doc.data().streak || 0
                        }));
                        
                        db.collection('friends')
                            .where('user2', '==', currentUser.username)
                            .onSnapshot(snapshot2 => {
                                const moreFriends = snapshot2.docs.map(doc => ({
                                    id: doc.id,
                                    friendUsername: doc.data().user1,
                                    streak: doc.data().streak || 0
                                }));
                                friends = [...friends, ...moreFriends];
                                render();
                            });
                        
                        render();
                    });
                
                db.collection('messages').onSnapshot(snapshot => {
                    messages = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    render();
                    if (currentView === 'chat' || currentView === 'groupChat') {
                        scrollToBottom();
                    }
                });
                
                db.collection('friendRequests').onSnapshot(snapshot => {
                    friendRequests = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    render();
                });
                
                db.collection('groups')
                    .where('members', 'array-contains', currentUser.username)
                    .onSnapshot(snapshot => {
                        groups = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        render();
                    });
                
                db.collection('stories')
                    .where('expiresAt', '>', new Date())
                    .orderBy('expiresAt', 'desc')
                    .orderBy('timestamp', 'desc')
                    .onSnapshot(snapshot => {
                        stories = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        render();
                    });
                
                render();
            } else {
                currentUser = null;
                currentView = 'auth';
                friends = [];
                messages = [];
                groups = [];
                friendRequests = [];
                stories = [];
                render();
            }
        });

        render();
    </script>
</body>
</html>
